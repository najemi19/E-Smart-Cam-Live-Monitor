<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Eâ€‘Smart Cam Monitor â€“ Unified</title>
  <meta name="theme-color" content="#1c2541" />
  <style>
    :root { --bg:#0b132b; --fg:#e0e6f5; --acc:#1c2541; --btn:#3a506b; --ok:#2ecc71; --bad:#e74c3c; --muted:#6b7a90; }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", Arial, sans-serif; }
    header.topbar { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:var(--acc); position:sticky; top:0; z-index:10; }
    .brand { font-weight:800; letter-spacing:.3px; }
    .container { padding:16px; max-width:1200px; margin:0 auto; }
    .grid { display:grid; grid-template-columns: 1fr; gap:14px; }
    @media(min-width:1100px){ .grid { grid-template-columns: 380px 1fr; } }
    .card { background:#121a33; border:1px solid #1e2a4f; border-radius:10px; padding:12px; }
    .section-title { font-size:14px; opacity:.9; margin-bottom:8px; }
    .controls, .options, .actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0; }
    select, button, input[type="text"], input[type="password"] { padding:8px 10px; border:none; border-radius:8px; background:#1a2345; color:var(--fg); outline:none; }
    button { background:var(--btn); cursor:pointer; }
    button.ghost { background:transparent; border:1px solid #6b7a90; }
    button.small { padding:6px 10px; font-size:13px; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .list { display:flex; flex-direction:column; gap:10px; }
    .cam { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px; border-radius:8px; background:#0f1733; border:1px solid #233058; }
    .cam .meta { display:flex; flex-direction:column; gap:2px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; }
    .badge.ok { background:rgba(46,204,113,.15); color:var(--ok); border:1px solid rgba(46,204,113,.3); }
    .badge.bad { background:rgba(231,76,60,.15); color:var(--bad); border:1px solid rgba(231,76,60,.3); }
    .badge.muted { background:rgba(107,122,144,.15); color:var(--muted); border:1px solid rgba(107,122,144,.3); }
    .player { background:#0a0f21; border:1px solid #223059; border-radius:10px; padding:10px; min-height:300px; display:flex; flex-direction:column; gap:8px; }
    video, img.live-snap { width:100%; max-height:65vh; background:#000; border-radius:8px; }
    .hint { font-size:12px; opacity:.85; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .divider { height:1px; background:#1f2b4e; margin:8px 0; }
    #eventLog { max-height:220px; overflow-y:auto; font-size:13px; background:#0f1733; border:1px solid #233058; border-radius:6px; padding:6px; }
    .log-filters { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill { padding:2px 8px; border-radius:999px; background:#1a2345; font-size:12px; border:1px solid #233058; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">Eâ€‘Smart Cam Monitor</div>
    <div class="row">
      <button id="btnInstall" class="ghost small" style="display:none;">ØªØ«Ø¨ÙŠØª</button>
      <span id="wsStatus" class="badge bad">WS: ØºÙŠØ± Ù…ØªØµÙ„</span>
    </div>
  </header>

  <div class="container grid">
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <aside class="card">
      <div class="section-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      <div class="actions">
        <button id="refreshBtn" class="small">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      </div>
      <div id="cams" class="list"></div>

      <div class="divider"></div>
      <div class="section-title">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</div>
      <div class="options">
        <label><input type="checkbox" id="dataSaver"> ÙˆØ¶Ø¹ ØªÙˆÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
        <label><input type="checkbox" id="lowLatency"> ÙˆØ¶Ø¹ Ù…Ù†Ø®ÙØ¶ Ø§Ù„ØªØ£Ø®ÙŠØ±</label>
      </div>

      <div class="divider"></div>
      <div class="section-title">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
      <div class="controls">
        <select id="cameraSelect"></select>
        <button id="playBtn">ØªØ´ØºÙŠÙ„</button>
      </div>

      <div class="divider"></div>
      <div class="section-title">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
      <div class="actions">
        <button id="exportLogBtn" class="small">ØªØµØ¯ÙŠØ± ÙƒÙ€ CSV</button>
        <span class="pill">ÙÙ„ØªØ±Ø©:</span>
        <div class="log-filters">
          <label class="pill"><input type="checkbox" id="filterStart" checked> ØªØ´ØºÙŠÙ„</label>
          <label class="pill"><input type="checkbox" id="filterStop" checked> Ø¥ÙŠÙ‚Ø§Ù</label>
          <label class="pill"><input type="checkbox" id="filterInfo" checked> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</label>
          <button id="clearLogBtn" class="small ghost">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>
      </div>
      <div id="eventLog"></div>
    </aside>

    <!-- Ø§Ù„Ù…Ø´ØºÙ„ -->
    <section class="card">
      <div class="section-title">Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</div>
      <div class="player">
        <video id="player" controls autoplay muted playsinline></video>
        <div class="row">
          <span id="nowPlaying" class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø« Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</span>
          <span id="camStatusIndicator" class="badge bad" style="margin-right:8px;">ğŸ”´</span>
        </div>
        <div class="row" id="playerControls" style="display:none;">
          <button id="btnStartCam" class="small">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
          <button id="btnStopCam" class="small ghost">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        </div>
        <div class="hint">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙŠØªØ·Ù„Ø¨ ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ. ÙŠØ¯Ø¹Ù… HLS ÙˆLLâ€‘HLS Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ù‡ÙŠØ£Ù‹.</div>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" style="
    position:fixed; bottom:20px; right:20px; background:rgba(0,0,0,0.85);
    color:#fff; padding:10px 16px; border-radius:6px; font-size:14px;
    opacity:0; pointer-events:none; transition:opacity 0.4s ease; z-index:9999;
  "></div>

  <!-- Ù…ÙƒØªØ¨Ø© Hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <script>
    // ØªÙƒÙˆÙŠÙ† Ø¹Ø§Ù…
    const API = {
      list: '/api/cameras',
      start: (name) => '/api/start/' + encodeURIComponent(name),
      stop:  (name) => '/api/stop/' + encodeURIComponent(name),
      signed: (cam) => '/api/stream-url?cam=' + encodeURIComponent(cam),
      snapshot: (cam) => '/snapshots/' + encodeURIComponent(cam) + '.jpg'
    };

    // Ø¹Ù†Ø§ØµØ± DOM
    let videoEl = document.getElementById('player');
    const camsEl = document.getElementById('cams');
    const playBtn = document.getElementById('playBtn');
    const cameraSelect = document.getElementById('cameraSelect');
    const dataSaverChk = document.getElementById('dataSaver');
    const lowLatencyChk = document.getElementById('lowLatency');
    const refreshBtn = document.getElementById('refreshBtn');
    const nowPlayingEl = document.getElementById('nowPlaying');
    const wsStatus = document.getElementById('wsStatus');
    const btnInstall = document.getElementById('btnInstall');
    const playerControls = document.getElementById('playerControls');
    const btnStartCam = document.getElementById('btnStartCam');
    const btnStopCam = document.getElementById('btnStopCam');
    const camStatusIndicator = document.getElementById('camStatusIndicator');
    const exportLogBtn = document.getElementById('exportLogBtn');
    const clearLogBtn = document.getElementById('clearLogBtn');
    const filterStart = document.getElementById('filterStart');
    const filterStop  = document.getElementById('filterStop');
    const filterInfo  = document.getElementById('filterInfo');

    // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let snapshotInterval = null;
    let hlsInstance = null;
    let camsCache = [];
    let lastRunningMap = new Map(); // Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ØªØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø©
    let pollingTimer = null;
    let ws = null;
    let currentCam = null;
    const eventHistory = []; // [{time, message, type}]

    // ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø©
    function showToast(message, type='info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.background = type === 'ok' ? 'rgba(46,204,113,0.9)' :
                               type === 'bad' ? 'rgba(231,76,60,0.9)' :
                               'rgba(0,0,0,0.85)';
      toast.style.opacity = '1';
      clearTimeout(toast._timeout);
      toast._timeout = setTimeout(() => { toast.style.opacity = '0'; }, 2500);
    }

    function addEventLog(message, type='info') {
      const logBox = document.getElementById('eventLog');
      const time = new Date().toLocaleTimeString('ar-MA', { hour12: false });
      // Ø­ÙØ¸ Ø§Ù„Ø­Ø¯Ø«
      eventHistory.unshift({ time, message, type });
      renderEventLog(); // ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
    }

    function renderEventLog() {
      const logBox = document.getElementById('eventLog');
      logBox.innerHTML = '';
      const activeTypes = new Set([
        ...(filterStart.checked ? ['ok'] : []),
        ...(filterStop.checked  ? ['bad'] : []),
        ...(filterInfo.checked  ? ['info'] : [])
      ]);
      eventHistory
        .filter(ev => activeTypes.has(ev.type))
        .slice(0, 500) // Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¹Ø±Ø¶
        .forEach(ev => {
          const color = ev.type === 'ok' ? '#2ecc71' : ev.type === 'bad' ? '#e74c3c' : '#ccc';
          const entry = document.createElement('div');
          entry.innerHTML = `<span style="color:${color}">[${ev.time}]</span> ${ev.message}`;
          logBox.appendChild(entry);
        });
    }

    function exportLogAsCSV() {
      const filtered = eventHistory.filter(ev => {
        if (ev.type === 'ok'  && !filterStart.checked) return false;
        if (ev.type === 'bad' && !filterStop.checked) return false;
        if (ev.type === 'info'&& !filterInfo.checked) return false;
        return true;
      });
      if (filtered.length === 0) {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ù„Ù„ØªØµØ¯ÙŠØ± ÙˆÙÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.');
        return;
      }
      const header = 'Ø§Ù„ÙˆÙ‚Øª,Ø§Ù„Ø­Ø¯Ø«,Ø§Ù„Ù†ÙˆØ¹\n';
      const rows = filtered.map(ev => `"${ev.time}","${ev.message.replace(/"/g,'""')}","${ev.type}"`).join('\n');
      const csvContent = header + rows;
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `event_log_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function labelOf(name) {
      const cam = camsCache.find(c => c.name === name);
      return cam ? (cam.label || cam.name) : name;
    }

    function updatePlayerButtonsState() {
      if (!currentCam) {
        btnStartCam.disabled = true;
        btnStopCam.disabled = true;
        return;
      }
      const cam = camsCache.find(c => c.name === currentCam);
      if (!cam) return;
      btnStartCam.disabled = !!cam.running;
      btnStopCam.disabled  = !cam.running;
    }

    function updateCamStatusIndicator() {
      if (!currentCam) {
        camStatusIndicator.textContent = 'ğŸ”´';
        camStatusIndicator.className = 'badge bad';
        return;
      }
      const cam = camsCache.find(c => c.name === currentCam);
      if (!cam) return;
      if (cam.running) {
        camStatusIndicator.textContent = 'ğŸŸ¢';
        camStatusIndicator.className = 'badge ok';
      } else {
        camStatusIndicator.textContent = 'ğŸ”´';
        camStatusIndicator.className = 'badge bad';
      }
    }

    // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª
    async function loadCameras() {
      const res = await fetch(API.list);
      const cams = await res.json();
      // ØªØ­Ø¯ÙŠØ« Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù‚Ø¨Ù„ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙƒØ§Ø´
      cams.forEach(c => {
        if (!lastRunningMap.has(c.name)) lastRunningMap.set(c.name, c.running);
      });
      camsCache = cams;
      renderCameraList(cams);
      fillSelect(cams);
      updatePlayerButtonsState();
      updateCamStatusIndicator();
    }

    function renderCameraList(cams) {
      camsEl.innerHTML = '';
      cams.forEach(cam => {
        const div = document.createElement('div');
        div.className = 'cam';
        div.innerHTML = `
          <div class="meta">
            <strong>${cam.label || cam.name}</strong>
            <span class="hint">Ø§Ù„ÙˆØ¶Ø¹: ${cam.mode} â€¢ Ø§Ù„Ø­Ø§Ù„Ø©:
              <span class="badge ${cam.running ? 'ok' : 'bad'}">${cam.running ? 'Ø´ØºÙ‘Ø§Ù„' : 'Ù…ØªÙˆÙ‚Ù'}</span>
            </span>
          </div>
          <div class="row">
            <button class="small" data-act="start" data-name="${cam.name}" ${cam.running ? 'disabled' : ''}>ØªØ´ØºÙŠÙ„</button>
            <button class="small ghost" data-act="stop" data-name="${cam.name}" ${cam.running ? '' : 'disabled'}>Ø¥ÙŠÙ‚Ø§Ù</button>
            <button class="small" data-act="play" data-name="${cam.name}">Ø¹Ø±Ø¶</button>
          </div>
        `;
        camsEl.appendChild(div);
      });
    }

    function fillSelect(cams) {
      const current = cameraSelect.value;
      cameraSelect.innerHTML = '';
      cams.forEach(cam => {
        const opt = document.createElement('option');
        opt.value = cam.name;
        opt.textContent = cam.label || cam.name;
        cameraSelect.appendChild(opt);
      });
      if (current) cameraSelect.value = current;
    }

    // ØªØ´ØºÙŠÙ„ Ø¨Ø«
    async function getSignedUrl(cam) {
      const res = await fetch(API.signed(cam));
      if (!res.ok) throw new Error('Failed to get signed URL');
      const data = await res.json();
      return data.url;
    }

    function clearPlayer() {
      if (hlsInstance) { try { hlsInstance.destroy(); } catch {} hlsInstance = null; }
      if (snapshotInterval) { clearInterval(snapshotInterval); snapshotInterval = null; }
    }

    async function playStream(cam) {
      clearPlayer();
      currentCam = cam;
      playerControls.style.display = 'flex';

      if (dataSaverChk.checked) {
        const imgEl = document.createElement('img');
        imgEl.className = 'live-snap';
        const playerBox = document.querySelector('.player');
        playerBox.innerHTML = '';
        playerBox.appendChild(imgEl);
        const update = () => imgEl.src = API.snapshot(cam) + '?ts=' + Date.now();
        update();
        snapshotInterval = setInterval(update, 2000);
        nowPlayingEl.textContent = 'ÙŠØ¹Ø±Ø¶ Ù„Ù‚Ø·Ø§Øª: ' + (labelOf(cam) || cam);
        updatePlayerButtonsState();
        updateCamStatusIndicator();
        return;
      }

      const playerBox = document.querySelector('.player');
      playerBox.innerHTML = '';
      videoEl = document.createElement('video');
      videoEl.id = 'player';
      videoEl.controls = true;
      videoEl.autoplay = true;
      videoEl.muted = true;
      videoEl.playsInline = true;
      playerBox.appendChild(videoEl);

      const src = await getSignedUrl(cam);
      nowPlayingEl.textContent = 'ÙŠØ¨Ø« Ø§Ù„Ø¢Ù†: ' + (labelOf(cam) || cam);

      if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
        videoEl.src = src;
        await videoEl.play().catch(()=>{});
      } else if (Hls.isSupported()) {
        hlsInstance = new Hls({
          lowLatencyMode: !!lowLatencyChk.checked,
          liveSyncDuration: lowLatencyChk.checked ? 1 : 2,
          liveMaxLatencyDuration: lowLatencyChk.checked ? 3 : 6,
          backBufferLength: 10
        });
        hlsInstance.loadSource(src);
        hlsInstance.attachMedia(videoEl);
        videoEl.play().catch(()=>{});
      } else {
        alert('Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… HLS.');
      }
      updatePlayerButtonsState();
      updateCamStatusIndicator();
    }

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    camsEl.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const name = btn.dataset.name;
      const act = btn.dataset.act;

      try {
        if (act === 'start' || act === 'stop') {
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: act, name }));
          } else {
            await fetch(act === 'start' ? API.start(name) : API.stop(name), { method: 'POST' });
          }
          // ØªØ­Ø¯ÙŠØ« UI ÙÙˆØ±ÙŠ Ù…Ø¨Ø¯Ø¦ÙŠ
          const c = camsCache.find(c => c.name === name);
          if (c) c.running = (act === 'start');
          renderCameraList(camsCache);
          if (currentCam === name) {
            updatePlayerButtonsState();
            updateCamStatusIndicator();
          }
          showToast(`${labelOf(name)} ${act === 'start' ? 'ØªÙ… ØªØ´ØºÙŠÙ„Ù‡Ø§ ğŸŸ¢' : 'ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§ ğŸ”´'}`, act === 'start' ? 'ok' : 'bad');
          addEventLog(`${labelOf(name)} ${act === 'start' ? 'ØªÙ… ØªØ´ØºÙŠÙ„Ù‡Ø§ ğŸŸ¢' : 'ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§ ğŸ”´'}`, act === 'start' ? 'ok' : 'bad');
        } else if (act === 'play') {
          cameraSelect.value = name;
          playSelected();
        }
      } catch (err) {
        console.error(err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.');
      }
    });

    refreshBtn.addEventListener('click', loadCameras);
    playBtn.addEventListener('click', playSelected);
    async function playSelected() {
      const cam = cameraSelect.value;
      await playStream(cam);
    }

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´ØºÙ„
    btnStartCam.addEventListener('click', () => {
      if (!currentCam) return;
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'start', name: currentCam }));
      } else {
        fetch(API.start(currentCam), { method: 'POST' });
      }
      const cam = camsCache.find(c => c.name === currentCam);
      if (cam) cam.running = true;
      updatePlayerButtonsState();
      updateCamStatusIndicator();
      showToast(`${labelOf(currentCam)} ØªÙ… ØªØ´ØºÙŠÙ„Ù‡Ø§ ğŸŸ¢`, 'ok');
      addEventLog(`${labelOf(currentCam)} ØªÙ… ØªØ´ØºÙŠÙ„Ù‡Ø§ ğŸŸ¢`, 'ok');
    });

    btnStopCam.addEventListener('click', () => {
      if (!currentCam) return;
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'stop', name: currentCam }));
      } else {
        fetch(API.stop(currentCam), { method: 'POST' });
      }
      const cam = camsCache.find(c => c.name === currentCam);
      if (cam) cam.running = false;
      updatePlayerButtonsState();
      updateCamStatusIndicator();
      showToast(`${labelOf(currentCam)} ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§ ğŸ”´`, 'bad');
      addEventLog(`${labelOf(currentCam)} ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§ ğŸ”´`, 'bad');
    });

    // WebSocket + Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    function connectWS() {
      const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
      const url = scheme + '://' + location.host + '/ws';
      try {
        ws = new WebSocket(url);
      } catch (e) {
        startPolling();
        return;
      }

      ws.onopen = () => {
        wsStatus.textContent = 'WS: Ù…ØªØµÙ„';
        wsStatus.className = 'badge ok';
        if (pollingTimer) { clearInterval(pollingTimer); pollingTimer = null; }
      };
      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);

          if (msg.type === 'status' && Array.isArray(msg.cameras)) {
            // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            msg.cameras.forEach(c => {
              const prev = lastRunningMap.get(c.name);
              if (prev !== undefined && prev !== c.running) {
                const text = `${labelOf(c.name)} ${c.running ? 'ØªÙ… ØªØ´ØºÙŠÙ„Ù‡Ø§ ğŸŸ¢' : 'ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§ ğŸ”´'}`;
                showToast(text, c.running ? 'ok' : 'bad');
                addEventLog(text, c.running ? 'ok' : 'bad');
              }
              lastRunningMap.set(c.name, c.running);
            });
            // Ø­Ø¯Ø« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¨Ø§Ù‚ÙŠ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§
            camsCache = camsCache.map(c => {
              const m = msg.cameras.find(x => x.name === c.name);
              return m ? { ...c, running: !!m.running } : c;
            });
            renderCameraList(camsCache);
            updatePlayerButtonsState();
            updateCamStatusIndicator();
          }

          if (msg.type === 'camera' && msg.name) {
            const prev = lastRunningMap.get(msg.name);
            if (prev !== undefined && prev !== !!msg.running) {
              const text = `${labelOf(msg.name)} ${msg.running ? 'ØªÙ… ØªØ´ØºÙŠÙ„Ù‡Ø§ ğŸŸ¢' : 'ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§ ğŸ”´'}`;
              showToast(text, msg.running ? 'ok' : 'bad');
              addEventLog(text, msg.running ? 'ok' : 'bad');
            }
            lastRunningMap.set(msg.name, !!msg.running);
            camsCache = camsCache.map(c => c.name === msg.name ? { ...c, running: !!msg.running } : c);
            renderCameraList(camsCache);
            updatePlayerButtonsState();
            updateCamStatusIndicator();
          }
        } catch {}
      };
      ws.onclose = () => {
        wsStatus.textContent = 'WS: ØºÙŠØ± Ù…ØªØµÙ„';
        wsStatus.className = 'badge bad';
        startPolling();
        setTimeout(connectWS, 3000);
      };
      ws.onerror = () => {
        try { ws.close(); } catch {}
      };
    }

    function startPolling() {
      if (pollingTimer) return;
      pollingTimer = setInterval(async () => {
        const prevMap = new Map(lastRunningMap);
        await loadCameras();
        // Ù‚Ø§Ø±Ù† ÙˆØ§Ø¸Ù‡Ø± Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
        camsCache.forEach(c => {
          const prev = prevMap.get(c.name);
          if (prev !== undefined && prev !== c.running) {
            const text = `${labelOf(c.name)} ${c.running ? 'ØªÙ… ØªØ´ØºÙŠÙ„Ù‡Ø§ ğŸŸ¢' : 'ØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§ ğŸ”´'}`;
            showToast(text, c.running ? 'ok' : 'bad');
            addEventLog(text, c.running ? 'ok' : 'bad');
          }
          lastRunningMap.set(c.name, c.running);
        });
      }, 5000);
    }

    // Service Worker Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
    (function registerSW() {
      if (!('serviceWorker' in navigator)) return;
      const swCode = `
        const CACHE='ui-v1';
        const ASSETS=['/','/index.html'];
        self.addEventListener('install', e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)))});
        self.addEventListener('activate', e=>{e.waitUntil(self.clients.claim())});
        self.addEventListener('fetch', e=>{
          const url=new URL(e.request.url);
          if(url.pathname.startsWith('/streams/')||url.pathname.startsWith('/snapshots/')) return;
          if(e.request.method!=='GET') return;
          e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
        });
      `;
      const blob = new Blob([swCode], { type:'text/javascript' });
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl);
    })();

    // Manifest Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ + Ø£ÙŠÙ‚ÙˆÙ†Ø© SVG
    (function dynamicManifest() {
      const svg = encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="#1c2541"/><circle cx="256" cy="256" r="160" fill="#3a506b"/><circle cx="256" cy="256" r="80" fill="#0b132b"/><rect x="200" y="120" width="112" height="28" rx="14" fill="#e0e6f5"/></svg>');
      const icon512 = 'data:image/svg+xml;charset=utf-8,' + svg;
      const manifest = {
        name: 'Eâ€‘Smart Cam Monitor',
        short_name: 'CamMonitor',
        start_url: '/',
        display: 'standalone',
        background_color: '#0b132b',
        theme_color: '#1c2541',
        icons: [
          { src: icon512, sizes: '192x192', type: 'image/svg+xml' },
          { src: icon512, sizes: '512x512', type: 'image/svg+xml' }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = url;
      document.head.appendChild(link);
    })();

    // Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      btnInstall.style.display = 'inline-block';
    });
    btnInstall.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        btnInstall.style.display = 'none';
      }
    });

    // Ø£Ø­Ø¯Ø§Ø« Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    exportLogBtn.addEventListener('click', exportLogAsCSV);
    clearLogBtn.addEventListener('click', () => {
      eventHistory.length = 0;
      renderEventLog();
      showToast('ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«', 'info');
    });
    [filterStart, filterStop, filterInfo].forEach(cb => cb.addEventListener('change', renderEventLog));

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    (async function init() {
      await loadCameras();
      // Ù…Ù„Ø¡ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù„Ù„Ù…Ø±Ù‘Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
      camsCache.forEach(c => lastRunningMap.set(c.name, c.running));
      connectWS(); // ÙŠØ¹ÙˆØ¯ Ù„Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙˆÙØ± WS
      addEventLog('Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¯Ø£Øª Ø§Ù„Ø¹Ù…Ù„ âœ…', 'info');
    })();
  </script>
</body>
</html>
