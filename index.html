<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>E‑Smart Cam Monitor</title>
<meta name="theme-color" content="#1c2541">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Crect width='100%25' height='100%25' fill='%231c2541'/%3E%3Ccircle cx='64' cy='64' r='40' fill='%232f80ed'/%3E%3Crect x='44' y='56' width='40' height='16' rx='8' fill='white'/%3E%3C/svg%3E" />

<!-- مكتبات مطلوبة -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root {
  --bg:#0b132b; --panel:#0f1733; --header:#1c2541; --pri:#2f80ed; --text:#fff;
}
* { box-sizing: border-box; }
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Naskh Arabic", Arial, sans-serif;
       background:var(--bg); color:var(--text); margin:0; }
header { background:var(--header); padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
h1 { margin:0; font-size:18px; font-weight:700; }
.btn { background:var(--pri); color:#fff; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
.btn:hover { opacity:.9; }
.toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.toggle { display:flex; align-items:center; gap:8px; padding:6px 8px; background:#0f2147; border-radius:8px; }
main { padding:16px; display:grid; grid-template-columns: 1fr; gap:16px; }
#cameraList { background:var(--panel); border-radius:10px; padding:12px; }
.camera-item { background:#0b1b3a; padding:10px; border-radius:8px; margin-bottom:8px; font-size:14px; }
#qrReader { margin:0 auto; max-width:340px; display:none; background:var(--panel); border-radius:10px; padding:10px; }
#playerContainer { background:var(--panel); border-radius:10px; padding:12px; }
video, img.snapshot { width:100%; max-width:100%; border-radius:8px; background:#000; aspect-ratio:16/9; object-fit:contain; }
.status { font-size:12px; opacity:.85; margin-top:6px; }
#notification {
  position: fixed; bottom: 20px; right: 20px; max-width: 320px;
  background: var(--pri); color:#fff; padding:12px 16px; border-radius:10px;
  box-shadow: 0 10px 24px rgba(0,0,0,.3); display:none; z-index: 9999;
}
#notification .actions { margin-top:8px; display:flex; gap:8px; }
#installBanner { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; z-index:9998;
                 background:#102145; color:#fff; padding:10px 14px; border-radius:10px; display:none; }
.small { font-size:12px; opacity:.8; }
.grid { display:grid; grid-template-columns:1fr; gap:16px; }
@media (min-width: 900px) {
  .grid { grid-template-columns: 1fr 1fr; }
}
.hr { height:1px; background:#102145; margin:10px 0; border:0; }
</style>
</head>
<body>

<header>
  <h1>E‑Smart Cam Monitor</h1>
  <div class="toolbar">
    <button id="addByQR" class="btn">➕ إضافة كاميرا عبر QR</button>
    <label class="toggle">
      <input type="checkbox" id="dataSaver" />
      توفير البيانات
    </label>
    <button id="installApp" class="btn" style="display:none;">⬇️ تثبيت كتطبيق</button>
  </div>
</header>

<main class="grid">
  <section id="cameraList">
    <strong>الكاميرات</strong>
    <div id="cams"></div>
    <div class="hr"></div>
    <div class="small">نصيحة: أضف كاميرا عبر QR ليبدأ البث مباشرة.</div>
  </section>

  <section>
    <div id="playerContainer">
      <strong>المشغل</strong>
      <div id="playerArea" class="status small">لا توجد كاميرا مشغّلة حاليًا.</div>
    </div>
    <div id="qrReader"></div>
  </section>
</main>

<div id="notification"></div>
<div id="installBanner">يمكن تثبيت التطبيق على جهازك. اضغط زر التثبيت في الأعلى.</div>

<script>
/* ============================================================
   حالة التطبيق
============================================================ */
let cameras = [];
let snapshotInterval = null;
let deferredPrompt = null;

/* ============================================================
   أدوات مساعدة
============================================================ */
function $(id) { return document.getElementById(id); }
function setStatus(msg) { const area = $('playerArea'); area.textContent = msg; area.className = 'status small'; }
function showNotification(message, actions = []) {
  const box = $('notification');
  box.innerHTML = '';
  const p = document.createElement('div'); p.textContent = message; box.appendChild(p);
  if (actions.length) {
    const act = document.createElement('div'); act.className = 'actions';
    actions.forEach(a => {
      const b = document.createElement('button');
      b.className = 'btn'; b.textContent = a.label;
      b.onclick = () => { a.onClick?.(); hideNotification(); };
      act.appendChild(b);
    });
    box.appendChild(act);
  }
  box.style.display = 'block';
  setTimeout(() => { box.style.display = 'none'; }, 6000);
}
function hideNotification(){ $('notification').style.display='none'; }

/* ============================================================
   عرض القائمة
============================================================ */
function renderCameraList() {
  const container = $('cams');
  container.innerHTML = '';
  cameras.forEach((cam, idx) => {
    const div = document.createElement('div');
    div.className = 'camera-item';
    div.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
        <div>${cam.name} — ${cam.host}:${cam.port} (${cam.streamType || 'hls'})</div>
        <div style="display:flex; gap:6px;">
          <button class="btn" data-play="${idx}">تشغيل</button>
          <button class="btn" data-del="${idx}" style="background:#c0392b;">حذف</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
  container.querySelectorAll('[data-play]').forEach(b=>{
    b.onclick = () => playStream(cameras[+b.dataset.play]);
  });
  container.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick = () => {
      const i = +b.dataset.del;
      cameras.splice(i,1);
      stopSnapshots();
      $('playerArea').innerHTML = 'تم إيقاف المشغل.';
      renderCameraList();
    };
  });
}

/* ============================================================
   تشغيل البث / وضع توفير البيانات
============================================================ */
function stopSnapshots(){
  if (snapshotInterval){ clearInterval(snapshotInterval); snapshotInterval = null; }
}
function playStream(cam) {
  const container = $('playerArea');
  container.innerHTML = '';
  stopSnapshots();

  const dataSaver = $('dataSaver').checked;

  if (dataSaver) {
    const img = document.createElement('img');
    img.className = 'snapshot';
    function updateSnapshot() {
      img.src = `${cam.snapshotUrl || `http://${cam.host}:${cam.port}/${cam.cameraId || ''}/snapshot.jpg`}?ts=${Date.now()}`;
    }
    updateSnapshot();
    snapshotInterval = setInterval(updateSnapshot, cam.snapshotIntervalMs || 5000);
    container.appendChild(img);
    setStatus('وضع توفير البيانات: عرض لقطات متجددة');
  } else {
    const video = document.createElement('video');
    video.controls = true;
    video.autoplay = true;
    video.playsInline = true;

    const streamUrl = cam.streamUrl || `http://${cam.host}:${cam.port}/${cam.cameraId || ''}/index.m3u8`;

    if (window.Hls && Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource(streamUrl);
      hls.attachMedia(video);
      hls.on(Hls.Events.ERROR, (ev, data) => {
        setStatus('تعذر تشغيل البث. قد تكون الشبكة بطيئة. جرّب تفعيل وضع توفير البيانات.');
      });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = streamUrl;
    } else {
      video.src = streamUrl;
    }

    container.appendChild(video);
    setStatus('تشغيل فيديو مباشر عبر HLS');
  }
}

/* ============================================================
   إضافة كاميرا عبر QR
============================================================ */
$('addByQR').addEventListener('click', () => {
  const area = $('qrReader'); area.style.display = 'block';
  const qr = new Html5Qrcode('qrReader');
  qr.start(
    { facingMode: 'environment' },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      try {
        const parsed = JSON.parse(decodedText);
        // مثال متوقع:
        // { "name":"Cam 1","host":"192.168.1.10","port":8080,"streamType":"hls","cameraId":"front","token":"abc123" }
        cameras.push(parsed);
        renderCameraList();
        playStream(parsed);
        showNotification('✅ تمت إضافة الكاميرا وتشغيلها مباشرة.');
        qr.stop(); area.style.display = 'none';
      } catch (e) {
        console.error('QR parse error', e);
        showNotification('❌ خطأ في قراءة كود الـ QR. تأكد من صيغة JSON.');
      }
    },
    (err) => { /* ignore scan errors */ }
  );
});

/* ============================================================
   كشف السرعة وتفعيل التوفير تلقائيًا
============================================================ */
async function checkConnectionSpeed() {
  const testUrl = 'https://via.placeholder.com/500x500.png?text=SpeedTest';
  const start = Date.now();
  try {
    await fetch(testUrl, { cache: 'no-store' });
    const s = (Date.now() - start) / 1000;
    const kbps = (500 * 8) / s; // تقدير تقريبي
    if (kbps < 800) {
      $('dataSaver').checked = true;
      showNotification(
        '⚠️ تم تفعيل وضع توفير البيانات تلقائيًا بسبب بطء الشبكة.',
        [{ label: 'إيقاف التوفير', onClick: () => { $('dataSaver').checked = false; } }]
      );
    }
  } catch {
    // تجاهل فشل الاختبار
  }
}
checkConnectionSpeed();

/* ============================================================
   تبديل وضع التوفير أثناء التشغيل
============================================================ */
$('dataSaver').addEventListener('change', () => {
  const current = cameras[cameras.length - 1];
  if (current) playStream(current);
});

/* ============================================================
   PWA: تسجيل Service Worker داخل نفس الملف
============================================================ */
if ('serviceWorker' in navigator) {
  // نص SW بسيط: cache-first للغلاف
  const swCode = `
    const CACHE='esm-cache-v1';
    const ASSETS = self.registration ? [] : [];
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['/'])).then(()=>self.skipWaiting()));
    });
    self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
    self.addEventListener('fetch', e=>{
      const url = new URL(e.request.url);
      if (e.request.method==='GET' && (url.origin===location.origin)) {
        e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request)));
      }
    });
  `;
  const blob = new Blob([swCode], { type: 'text/javascript' });
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(()=>{});
}

/* ============================================================
   PWA: زر التثبيت
============================================================ */
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  $('installApp').style.display = 'inline-block';
  $('installBanner').style.display = 'block';
});
$('installApp').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  $('installApp').style.display = 'none';
  $('installBanner').style.display = 'none';
});

/* ============================================================
   حفظ الكاميرات محليًا
============================================================ */
function saveCams(){ try{ localStorage.setItem('esm_cams', JSON.stringify(cameras)); }catch{} }
function loadCams(){ try{ const d = localStorage.getItem('esm_cams'); if(d){ cameras = JSON.parse(d) || []; } }catch{} }
window.addEventListener('beforeunload', saveCams);
loadCams(); renderCameraList();
</script>

</body>
</html>
